build-extension: true
id: project.dev.environ.extension.gcc-4_8_5
branch: '20.08'
sdk: project.dev.image-sdk
runtime: project.dev.image-sdk
runtime-version: '20.08'
separate-locales: false
appstream-compose: false

modules:
  - name: gcc
    buildsystem: simple
    builddir: true
    build-commands:
      - ./install.sh
    sources:
      - type: script
        dest-filename: install.sh
        commands:
          - set -e
          - export CFLAGS="-O2 -g -pipe -Wp,-D_FORTIFY_SOURCE=2 -Wp,-D_GLIBCXX_ASSERTIONS -fexceptions -fstack-protector-all -grecord-gcc-switches -fasynchronous-unwind-tables"
          - export CXXFLAGS="$CFLAGS"
          - cd gcc
          - ln -sf ../mpfr mpfr
          - ln -sf ../gmp gmp
          - ln -sf ../mpc mpc
          - ln -sf ../isl isl
          - ln -sf ../cloog cloog
          - patch -Np1 -i ../gperf.patch
          - patch -Np1 -i ../libsanitizer.patch
          - patch -Np1 -i ../libgcc_ucontext.patch
          - patch -Np1 -i ../asan_signal.patch
          - sed -i -e 's/__attribute__/\/\/__attribute__/g' gcc/cp/cfns.h
          - mkdir ../build; cd ../build
          - >
            ../gcc/configure
            --prefix=$FLATPAK_DEST
            --enable-deterministic-archives
            --enable-shared
            --enable-threads=posix
            --enable-__cxa_atexit
            --enable-clocale=gnu
            --enable-multilib
            --with-multilib-list=m32,m64
            --enable-multiarch
            --disable-bootstrap
            --enable-languages=c,c++
            --enable-default-pie
            --enable-default-ssp
            --disable-libssp
            --enable-linker-build-id
            --disable-libstdcxx-filesystem-ts
            --enable-cet
            --with-system-zlib
            --with-tune=generic
            MAKEINFO=missing
          - make -j4 STAGE1_CXXFLAGS="-O2 -g -std=gnu++98"
          - make -j4 install
      - type: archive
        dest: gcc
        url: https://ftp.gnu.org/gnu/gcc/gcc-4.8.5/gcc-4.8.5.tar.bz2
        sha256: 22fb1e7e0f68a63cee631d85b20461d1ea6bda162f03096350e38c8d427ecf23
      - type: archive
        dest: mpfr
        url: https://www.mpfr.org/mpfr-current/mpfr-4.1.0.tar.xz
        sha256: 0c98a3f1732ff6ca4ea690552079da9c597872d30e96ec28414ee23c95558a7f
      - type: archive
        dest: gmp
        url: ftp://gcc.gnu.org/pub/gcc/infrastructure/gmp-6.1.0.tar.bz2
        sha256: 498449a994efeba527885c10405993427995d3f86b8768d8cdf8d9dd7c6b73e8
      - type: archive
        dest: mpc
        url: https://ftp.gnu.org/gnu/mpc/mpc-1.2.1.tar.gz
        sha256: 17503d2c395dfcf106b622dc142683c1199431d095367c6aacba6eec30340459
      - type: archive
        dest: isl
        url: https://gcc.gnu.org/pub/gcc/infrastructure/isl-0.14.tar.bz2
        sha256: 7e3c02ff52f8540f6a85534f54158968417fd676001651c8289c705bd0228f36
      - type: archive
        dest: cloog
        url: http://www.bastoul.net/cloog/pages/download/cloog-0.18.4.tar.gz
        sha256: 325adf3710ce2229b7eeb9e84d3b539556d093ae860027185e7af8a8b00a750e
      - type: file
        path: gperf.patch
      - type: file
        path: asan_signal.patch
      - type: file
        path: libgcc_ucontext.patch
      - type: file
        path: libsanitizer.patch
