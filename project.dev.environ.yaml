app-id: project.dev.environ
branch: '20.08'
runtime: org.freedesktop.Sdk
runtime-version: '20.08'
sdk: org.freedesktop.Sdk

command: environ.sh
modules:
  - name: jsonnet
    buildsystem: simple
    build-options:
      cflags: -g -03 -Wall -Wextra -pedantic -std=c99 -fPIC
      cxxflags: -g -O3 -Wall -Wextra -Woverloaded-virtual -pedantic -std=c++0x -fPIC
      env:
        PREFIX: /app
    build-commands:
      # diff -Naru file_original file_updated > file.patch
      - patch -Np0 -i make_install.patch
      - make -j4
      - make install
    sources:
      - type: archive
        url: https://github.com/google/jsonnet/archive/v0.17.0.tar.gz
        sha256: 076b52edf888c01097010ad4299e3b2e7a72b60a41abbc65af364af1ed3c8dbe
      - type: file
        path: make_install.patch
  - name: environ.sh
    buildsystem: simple
    build-commands:
      - install environ.sh -Dt /app/bin
      - install bashrc -Dt /app/configs
      - ln -s /app/bin/environ.sh /app/bin/sh
      - ln -s /app/bin/environ.sh /app/bin/bash
    sources:
      - type: script
        dest-filename: environ.sh
        commands:
          - if [ $# -eq 0 ]; then
          - exec /usr/bin/bash --rcfile /app/configs/bashrc
          - else
          - exec jsonnet -e ${@:1}
          - fi
      - type: script
        dest-filename: bashrc
        commands:
          - export PS1="\u@$FLATPAK_ID \[\e[34m\]\w\[\e[0m\]\n[\[\e[31m\]ðŸ“¦\[\e[0m\]]$ "
          - alias ls='ls --color=auto'

finish-args:
  - --filesystem=host
  - --socket=session-bus
  - --allow=devel
